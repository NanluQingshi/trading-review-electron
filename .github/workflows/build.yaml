name: Build and Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, windows-latest]

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          # ğŸŸ¢ å…³é”®ç‚¹ 1ï¼šå¿…é¡»å¼ºåˆ¶ä½¿ç”¨ Node 20 (LTS)
          # Node 22/24 åœ¨ Windows CI ä¸Šå®‰è£… Electron ææ˜“å´©æºƒ
          node-version: 20
          cache: "npm"

      - name: Install Dependencies
        # ğŸŸ¢ å…³é”®ç‚¹ 2ï¼šä½¿ç”¨ 'npm ci' è€Œä¸æ˜¯ 'npm install'
        # 'npm ci' æ˜¯ä¸“é—¨ä¸º CI è®¾è®¡çš„ï¼ˆClean Installï¼‰ï¼Œå®ƒä¼šç›´æ¥è¯»å– package-lock.json
        # é€Ÿåº¦æ›´å¿«ï¼Œä¸”èƒ½é¿å…å›  node_modules ç¼“å­˜é”æ­»å¯¼è‡´çš„ EBUSY/EPERM é”™è¯¯
        run: npm ci

      - name: Rebuild Native Modules
        shell: bash
        run: |
          npm run rebuild -- --force
        env:
          npm_config_runtime: electron
          # è¿™é‡Œå¡«ä½ ç¡®è®¤çš„ 40.0.0
          npm_config_target: 40.0.0
          npm_config_disturl: https://electronjs.org/headers

      - name: Make (Build & Package)
        run: npm run make

      # ğŸ‘‡ ä¿®æ­£2ï¼šè·å–çœŸå®çš„ Electron ç‰ˆæœ¬å¹¶ Rebuild
      # ç›¸æ¯”æ‰‹åŠ¨å†™æ­»ç‰ˆæœ¬å·ï¼Œæ›´æ¨èè®© electron-rebuild è‡ªåŠ¨æ£€æµ‹
      # æˆ–è€…å¦‚æœä½ æƒ³æ‰‹åŠ¨æŒ‡å®šï¼Œå¿…é¡»å¡«å†™çœŸå®çš„ç‰ˆæœ¬å·ï¼
      - name: Rebuild Native Modules
        shell: bash
        run: |
          # å°è¯•è‡ªåŠ¨ rebuildã€‚å¦‚æœä½ çš„ package.json é‡Œæœ‰ "rebuild" è„šæœ¬åˆ™è¿è¡Œå®ƒ
          # å¦‚æœæ²¡æœ‰ï¼ŒForge é€šå¸¸åœ¨ npm install æ—¶ä¼šè‡ªåŠ¨å¤„ç†ï¼Œæˆ–è€…åœ¨ make æ—¶å¤„ç†
          # è¿™é‡Œä¸ºäº†ä¿é™©ï¼Œæ˜¾å¼è°ƒç”¨ electron-rebuild (å¦‚æœæ²¡æœ‰è¿™ä¸ªå‘½ä»¤ï¼Œè¿™ä¸€æ­¥å¯ä»¥åˆ é™¤)
          npm run rebuild -- --force
        env:
          npm_config_runtime: electron
          npm_config_target: 40.0.0  # ğŸ‘ˆ ä¿®æ­£3ï¼šè¯·åŠ¡å¿…å» package.json æŸ¥çœ‹ä½ çš„ electron ç‰ˆæœ¬å¹¶å¡«åœ¨è¿™é‡Œï¼ï¼
          npm_config_disturl: https://electronjs.org/headers

      - name: Make (Build & Package)
        run: npm run make

      - name: Upload Artifacts to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          # ğŸ‘‡ ä¿®æ­£4ï¼šä¸ºäº†ä¿é™©ï¼ŒåŒæ—¶æ¶µç›– dist å’Œ out ç›®å½•
          # å› ä¸ºå¦‚æœä¸ç¡®å®šä½ çš„ forge é…ç½®åˆ°åº•æ˜¯ dist è¿˜æ˜¯ outï¼Œè¿™æ ·å†™æœ€ç¨³å¦¥
          files: |
            dist/make/**/*.zip
            dist/make/**/*.dmg
            dist/make/**/*.exe
            dist/make/**/*.rpm
            dist/make/**/*.deb
            out/make/**/*.zip
            out/make/**/*.dmg
            out/make/**/*.exe
            out/make/**/*.rpm
            out/make/**/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}