name: Build and Release

on:
  push:
    tags:
      - "v*"
permissions:
  contents: write      

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, windows-latest]

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          # ğŸŸ¢ å…³é”®ç‚¹ 1ï¼šå¿…é¡»å¼ºåˆ¶ä½¿ç”¨ Node 20 (LTS)
          # Node 22/24 åœ¨ Windows CI ä¸Šå®‰è£… Electron ææ˜“å´©æºƒ
          node-version: 20
          cache: "npm"

      - name: Install Dependencies
        # ğŸŸ¢ å…³é”®ç‚¹ 2ï¼šä½¿ç”¨ 'npm ci' è€Œä¸æ˜¯ 'npm install'
        # 'npm ci' æ˜¯ä¸“é—¨ä¸º CI è®¾è®¡çš„ï¼ˆClean Installï¼‰ï¼Œå®ƒä¼šç›´æ¥è¯»å– package-lock.json
        # é€Ÿåº¦æ›´å¿«ï¼Œä¸”èƒ½é¿å…å›  node_modules ç¼“å­˜é”æ­»å¯¼è‡´çš„ EBUSY/EPERM é”™è¯¯
        run: npm ci

      - name: Rebuild Native Modules
        shell: bash
        run: |
          npm run rebuild -- --force
        env:
          npm_config_runtime: electron
          npm_config_target: 40.0.0
          npm_config_disturl: https://electronjs.org/headers

      - name: Make (Build & Package)
        run: npm run make

      - name: Rebuild Native Modules
        shell: bash
        run: |
          # å°è¯•è‡ªåŠ¨ rebuildã€‚å¦‚æœä½ çš„ package.json é‡Œæœ‰ "rebuild" è„šæœ¬åˆ™è¿è¡Œå®ƒ
          # å¦‚æœæ²¡æœ‰ï¼ŒForge é€šå¸¸åœ¨ npm install æ—¶ä¼šè‡ªåŠ¨å¤„ç†ï¼Œæˆ–è€…åœ¨ make æ—¶å¤„ç†
          # è¿™é‡Œä¸ºäº†ä¿é™©ï¼Œæ˜¾å¼è°ƒç”¨ electron-rebuild (å¦‚æœæ²¡æœ‰è¿™ä¸ªå‘½ä»¤ï¼Œè¿™ä¸€æ­¥å¯ä»¥åˆ é™¤)
          npm run rebuild -- --force
        env:
          npm_config_runtime: electron
          npm_config_target: 40.0.0  # ğŸ‘ˆ ä¿®æ­£3ï¼šè¯·åŠ¡å¿…å» package.json æŸ¥çœ‹ä½ çš„ electron ç‰ˆæœ¬å¹¶å¡«åœ¨è¿™é‡Œï¼ï¼
          npm_config_disturl: https://electronjs.org/headers

      - name: Make (Build & Package)
        run: npm run make

      - name: List Output Files (Debug)
        shell: bash
        run: |
          ls -R out || echo "out directory not found"

      - name: Upload Artifacts to Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            dist/**/*.zip
            dist/**/*.dmg
            dist/**/*.exe
            dist/**/*.rpm
            dist/**/*.deb
            out/**/*.zip
            out/**/*.dmg
            out/**/*.exe
            out/**/*.rpm
            out/**/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}